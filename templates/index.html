<!DOCTYPE html>
<html>
<head>
  <title>Web3 Portfolio Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #121212; color: white; }
    .price-up { color: #4caf50; }
    .price-down { color: #f44336; }
    .fade { transition: background-color 0.5s ease; }
  </style>
</head>
<body class="container mt-5">
  <h2>ðŸ”— Web3 Portfolio Tracker</h2>

  <form method="POST" class="mb-4">
    <input type="text" name="wallet_address" placeholder="Enter Ethereum Wallet Address" class="form-control mb-2" value="{{ wallet_address }}">
    <button type="submit" class="btn btn-primary">Track Wallet</button>
  </form>

  {% if error %}
  <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  {% if wallet_address %}
  <div id="wallet-data">
    <h4>ðŸ’° Portfolio Value: ${{ total_usd_value }}</h4>
    <table class="table table-dark table-striped mt-3">
      <thead><tr><th>Token</th><th>Balance</th><th>USD Value</th><th>24h Change</th></tr></thead>
      <tbody>
        {% for token in tokens %}
        <tr class="fade">
          <td>{{ token.name }}</td>
          <td>{{ token.balance }}</td>
          <td>${{ token.usd_value }}</td>
          <td class="{% if token.change >= 0 %}price-up{% else %}price-down{% endif %}">
            {{ token.change }}%
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h5>ðŸ“ˆ 24-Hour Price Trends</h5>
    <canvas id="priceTrendChart"></canvas>
  </div>
  {% endif %}

  <script>
    let walletAddress = "{{ wallet_address }}";
    if (walletAddress) {
      setInterval(() => {
        fetch(`/refresh/${walletAddress}`)
          .then(res => res.json())
          .then(data => {
            document.querySelector("#wallet-data").classList.add("fade");
            setTimeout(() => document.querySelector("#wallet-data").classList.remove("fade"), 500);
            location.reload(); // Quick refresh for demo; can replace with dynamic update later
          });
      }, 60000);
    }

    {% if price_trends %}
    const ctx = document.getElementById('priceTrendChart').getContext('2d');
    const trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length: {{ price_trends['ethereum']|length }}}, (_, i) => i),
        datasets: [
          { label: 'ETH', data: {{ price_trends['ethereum'] }}, borderColor: '#36a2eb', fill: false },
          { label: 'USDT', data: {{ price_trends['tether'] }}, borderColor: '#4bc0c0', fill: false },
          { label: 'USDC', data: {{ price_trends['usd-coin'] }}, borderColor: '#ffcd56', fill: false },
          { label: 'DAI', data: {{ price_trends['dai'] }}, borderColor: '#ff6384', fill: false }
        ]
      },
      options: {
        scales: { x: { ticks: { color: 'white' } }, y: { ticks: { color: 'white' } } },
        plugins: { legend: { labels: { color: 'white' } } }
      }
    });
    {% endif %}
  </script>
</body>
</html>
